<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Crush Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Crush Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="crush"><a class="header" href="#crush">Crush</a></h1>
<p><strong>A polyglot Virtual Operating System (vOS) with capability-based security</strong></p>
<p>Crush acts as a <strong>virtual operating system</strong> that expands and uplifts the host kernel, enabling code from multiple programming languages (Python, Rust, C, Go, Bash) to run in a single, secure execution environment with memory safety guarantees and fine-grained permission control.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>ğŸŒ <strong>Polyglot Execution</strong>: Compile and run Python, Rust, C, Go, and Bash code</li>
<li>ğŸš <strong>Interactive Shell</strong>: Full REPL with standard shell syntax (<code>ls</code>, <code>git</code>) and scripting</li>
<li>ğŸ”’ <strong>Capability-Based Security</strong>: Sandboxed access to I/O, filesystem, and network</li>
<li>ğŸ“¦ <strong>Capsule Isolation</strong>: Per-capsule Virtual File System (VFS) and scoped resource handles</li>
<li>ğŸ“œ <strong>Permission Manifests</strong>: Declare and enforce required capabilities at runtime</li>
<li>ğŸ§  <strong>Memory Safety</strong>: Arena-based memory management with runtime borrow checking</li>
<li>âš¡ <strong>Control Flow</strong>: Full support for if/else, while loops, and comparisons</li>
<li>ğŸ”§ <strong>Extensible</strong>: Modular architecture with <code>crush-shell</code> and <code>crush-stdlib</code></li>
</ul>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h2>
<h3 id="installation"><a class="header" href="#installation">Installation</a></h3>
<pre><code class="language-bash"># Clone the repository
git clone https://github.com/crush-dev/crush.git
cd crush

# Build the project
cargo build --release

# Add to PATH
export PATH="$PWD/target/release:$PATH"
</code></pre>
<h3 id="interactive-shell"><a class="header" href="#interactive-shell">Interactive Shell</a></h3>
<p>Run <code>crush</code> to enter the interactive shell. It supports standard shell commands and Crush scripting.</p>
<pre><code class="language-bash">$ crush
Crush Interactive REPL
Type ':help' for assistance or 'exit' to quit.
crush (crush)&gt; echo "Hello World"
=&gt; Hello World
crush (crush)&gt; ls -la
... (file listing) ...
crush (crush)&gt; :set lang python
crush (python)&gt; print("Hello from Python")
=&gt; Hello from Python
</code></pre>
<h3 id="running-scripts"><a class="header" href="#running-scripts">Running Scripts</a></h3>
<p>Create <code>hello.py</code>:</p>
<pre><code class="language-python">print("Hello from Crush!")
</code></pre>
<p>Compile and run:</p>
<pre><code class="language-bash">crush compile hello.py
crush run hello.py.casm.json
</code></pre>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python Code â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ python_walker
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust Code   â”‚â”€â”€â”€â”€â–¶â”‚ CAST (JSON)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ crush_compiler
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ C Code      â”‚     â”‚ CASM (JSON)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Crush VM    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="compilation-pipeline"><a class="header" href="#compilation-pipeline">Compilation Pipeline</a></h3>
<ol>
<li><strong>Source â†’ CAST</strong>: Language-specific walkers translate source code to Crush AST</li>
<li><strong>CAST â†’ CASM</strong>: Crush compiler generates bytecode with control flow compilation</li>
<li><strong>CASM â†’ Execution</strong>: VM executes bytecode with permission enforcement</li>
</ol>
<h2 id="capabilities"><a class="header" href="#capabilities">Capabilities</a></h2>
<p>Crush provides sandboxed access to host resources through capabilities:</p>
<div class="table-wrapper"><table><thead><tr><th>Capability</th><th>Description</th><th>Permission</th></tr></thead><tbody>
<tr><td><code>io.print</code></td><td>Print to stdout</td><td><code>io.print</code></td></tr>
<tr><td><code>io.input</code></td><td>Read from stdin</td><td><code>io.input</code></td></tr>
<tr><td><code>fs.read</code></td><td>Read files</td><td><code>fs.read</code></td></tr>
<tr><td><code>fs.write</code></td><td>Write files</td><td><code>fs.write</code></td></tr>
<tr><td><code>net.http_get</code></td><td>HTTP GET requests</td><td><code>net.http_get</code></td></tr>
<tr><td><code>ffi.call</code></td><td>Call native functions</td><td><code>ffi.call</code></td></tr>
</tbody></table>
</div>
<h3 id="permission-manifests"><a class="header" href="#permission-manifests">Permission Manifests</a></h3>
<p>Programs declare required capabilities in their manifest:</p>
<pre><code class="language-json">{
  "manifest": {
    "permissions": ["io.print", "fs.read"]
  }
}
</code></pre>
<p>The VM enforces these permissions at runtime, denying unauthorized capability calls.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<h3 id="filesystem-access"><a class="header" href="#filesystem-access">Filesystem Access</a></h3>
<pre><code class="language-python"># Write to file
__crush_call__("fs.write", "output.txt", "Hello, World!")

# Read from file
content = __crush_call__("fs.read", "output.txt")
print(content)
</code></pre>
<h3 id="network-request"><a class="header" href="#network-request">Network Request</a></h3>
<pre><code class="language-python">html = __crush_call__("net.http_get", "http://example.com")
print(html)
</code></pre>
<h3 id="ffi-foreign-function-interface"><a class="header" href="#ffi-foreign-function-interface">FFI (Foreign Function Interface)</a></h3>
<pre><code class="language-python"># Call native C function
result = __crush_call__("ffi.call", "libc.so.6", "strlen", "hello")
print(result)  # 5
</code></pre>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<ul>
<li><strong><a href="languages/cast-spec.html">CAST Specification</a></strong>: Formal definition of Crush AST</li>
<li><strong><a href="docs/GETTING_STARTED.html">Getting Started</a></strong>: Detailed tutorial</li>
<li><strong><a href="https://docs.rs/crush-vm">API Documentation</a></strong>: Rustdoc for all crates</li>
<li><strong><a href="docs/ARCHITECTURE.html">Architecture</a></strong>: Design and implementation details</li>
</ul>
<h2 id="project-structure"><a class="header" href="#project-structure">Project Structure</a></h2>
<pre><code>crush/
â”œâ”€â”€ crush-shell/       # Interactive shell logic (embeddable)
â”œâ”€â”€ crush-cli/         # CLI entry point
â”œâ”€â”€ crush-vm/          # Virtual machine implementation
â”œâ”€â”€ crush-stdlib/      # Standard library capabilities (FS, IO, System)
â”œâ”€â”€ crush-core/        # Shared types and IPC
â”œâ”€â”€ kernel/            # Exo-kernel with capability implementations
â”œâ”€â”€ languages/
â”‚   â”œâ”€â”€ casm/          # CASM bytecode format
â”‚   â”œâ”€â”€ python_walker/ # Python â†’ CAST translator
â”‚   â”œâ”€â”€ rust_walker/   # Rust â†’ CAST translator
â”‚   â”œâ”€â”€ c_walker/      # C â†’ CAST translator
â”‚   â”œâ”€â”€ go_walker/     # Go â†’ CAST translator
â”‚   â””â”€â”€ crush_compiler/# CAST â†’ CASM compiler
â”œâ”€â”€ examples/          # Example programs
â””â”€â”€ docs/              # Documentation
</code></pre>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<h3 id="running-tests"><a class="header" href="#running-tests">Running Tests</a></h3>
<pre><code class="language-bash">cargo test --workspace
</code></pre>
<h3 id="building-documentation"><a class="header" href="#building-documentation">Building Documentation</a></h3>
<pre><code class="language-bash">cargo doc --workspace --open
</code></pre>
<h3 id="adding-a-new-language-walker"><a class="header" href="#adding-a-new-language-walker">Adding a New Language Walker</a></h3>
<p>See <a href="docs/CONTRIBUTING.html">CONTRIBUTING.md</a> for a guide on adding new language support.</p>
<h2 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h2>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Polyglot compilation pipeline</li>
<li><input disabled="" type="checkbox" checked=""/>
Memory arena with borrow checking</li>
<li><input disabled="" type="checkbox" checked=""/>
Permission manifests</li>
<li><input disabled="" type="checkbox" checked=""/>
Control flow (if/while)</li>
<li><input disabled="" type="checkbox" checked=""/>
Comparison and bitwise operators</li>
<li><input disabled="" type="checkbox" checked=""/>
Process isolation (IPC-based Capsule/HAL isolation)</li>
<li><input disabled="" type="checkbox"/>
For loops and iterators</li>
<li><input disabled="" type="checkbox"/>
Classes and structs</li>
<li><input disabled="" type="checkbox"/>
Exception handling</li>
<li><input disabled="" type="checkbox"/>
Concurrency primitives</li>
</ul>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p>MIT License - see <a href="LICENSE">LICENSE</a> for details.</p>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>Contributions are welcome! Please see <a href="docs/CONTRIBUTING.html">CONTRIBUTING.md</a> for guidelines.</p>
<h2 id="acknowledgments"><a class="header" href="#acknowledgments">Acknowledgments</a></h2>
<p>Inspired by:</p>
<ul>
<li><strong>WebAssembly</strong>: Portable bytecode format</li>
<li><strong>Rust</strong>: Memory safety without garbage collection</li>
<li><strong>Capability-based security</strong>: Principle of least privilege</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>This chapter will guide you through setting up Crush and running your first program.</p>
<ul>
<li><a href="./installation.html">Installation</a>: How to build and install Crush.</li>
<li><a href="./hello_world.html">Hello World</a>: Writing and executing your first script.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation-1"><a class="header" href="#installation-1">Installation</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><strong>Rust</strong>: Ensure you have a recent version of Rust installed (1.70+ recommended).
<pre><code class="language-bash">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
</code></pre>
</li>
</ul>
<h2 id="building-from-source"><a class="header" href="#building-from-source">Building from Source</a></h2>
<p>Clone the repository and build the workspace:</p>
<pre><code class="language-bash">git clone https://github.com/nixp/crush.git
cd crush
cargo build --release
</code></pre>
<h2 id="installing-the-cli"><a class="header" href="#installing-the-cli">Installing the CLI</a></h2>
<p>You can install the <code>crush</code> binary directly to your cargo bin path:</p>
<pre><code class="language-bash">cargo install --path crush-cli
</code></pre>
<p>Verify the installation:</p>
<pre><code class="language-bash">crush --version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hello-world"><a class="header" href="#hello-world">Hello World</a></h1>
<p>Let's write a simple Crush script.</p>
<h2 id="1-create-a-file"><a class="header" href="#1-create-a-file">1. Create a File</a></h2>
<p>Create a file named <code>hello.crush</code> with the following content:</p>
<pre><code class="language-python"># hello.crush
def main():
    io.print("Hello, World!")
</code></pre>
<h2 id="2-run-it"><a class="header" href="#2-run-it">2. Run It</a></h2>
<p>Execute the script using the <code>crush</code> CLI:</p>
<pre><code class="language-bash">crush run hello.crush
</code></pre>
<p>You should see:</p>
<pre><code class="language-text">Hello, World!
</code></pre>
<h2 id="3-how-it-works"><a class="header" href="#3-how-it-works">3. How It Works</a></h2>
<ol>
<li><strong>Source</strong>: The <code>.crush</code> file is parsed into an AST.</li>
<li><strong>Compilation</strong>: The AST is compiled into CASM (Crush Assembly) instructions.</li>
<li><strong>VM</strong>: The Crush VM executes the instructions.</li>
<li><strong>Capabilities</strong>: The <code>io.print</code> function is a <em>capability</em> provided by the standard library. The VM ensures the script has permission (though currently <code>io.print</code> is often permissible by default or part of the base set).</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h1>
<p>This section details the internal design of the Crush eco-system.</p>
<ul>
<li><a href="./arch_overview.html">Overview</a>: High-level system design.</li>
<li><a href="./exo_core.html">EXO Core Contract</a>: The separation of mechanism and meaning.</li>
<li><a href="./crush_vm.html">Crush VM</a>: The capability-based virtual machine.</li>
<li><a href="./crush_lang.html">Crush Lang</a>: The language specification and compilation pipeline.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-overview"><a class="header" href="#architecture-overview">Architecture Overview</a></h1>
<p>Crush is built on a layered architecture designed to enforce the <strong>EXO Core Contract</strong>: <em>Mechanism belongs to the system; Meaning belongs to the capsule.</em></p>
<h2 id="layers"><a class="header" href="#layers">Layers</a></h2>
<pre><code class="language-mermaid">graph TD
    A[Capsule Code] --&gt;|Compiles to| B[CASM Bytecode]
    B --&gt;|Executed by| C[Crush VM]
    C --&gt;|Uses| D[Capabilities (Stdlib)]
    D --&gt;|Calls| E[HAL (Hardware Abstraction Layer)]
    E --&gt;|Abstracts| F[Host OS (Linux, etc.)]
</code></pre>
<ol>
<li><strong>Capsule Code</strong>: The source logic (Crush, Python, Rust, etc.).</li>
<li><strong>VM</strong>: The sandbox execution environment. It knows nothing about files or network, only instructions and abstract capabilities.</li>
<li><strong>Capabilities</strong>: The "standard library" functions (e.g., <code>fs.read</code>, <code>io.print</code>) that provide meaning to resource access.</li>
<li><strong>HAL</strong>: The strictly defined interface to the outside world. It handles the raw mechanism of reading bytes or opening sockets, without enforcing policy.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exo-core-contract"><a class="header" href="#exo-core-contract">EXO Core Contract</a></h1>
<p>The <strong>EXO Core Contract</strong> is the philosophical foundation of Crush. It dictates a strict separation of concerns to maximize portability and security.</p>
<h2 id="the-principle"><a class="header" href="#the-principle">The Principle</a></h2>
<blockquote>
<p><strong>EXO owns mechanism. Capsule owns meaning.</strong></p>
</blockquote>
<h2 id="implications"><a class="header" href="#implications">Implications</a></h2>
<ol>
<li><strong>No Ambient Authority</strong>: A capsule cannot simply "open a file". It must possess a capability (mechanism) granted by the host, and it uses that capability to perform an action (meaning).</li>
<li><strong>Explicit Dependencies</strong>: All capabilities required by a capsule must be declared in its <strong>Manifest</strong>.
<pre><code class="language-json">{
    "required_capabilities": ["fs.read", "io.print"]
}
</code></pre>
</li>
<li><strong>HAL Isolation</strong>: The VM and Standard Library must never call Host OS APIs directly (e.g., <code>std::fs::File::open</code>). Instead, they must go through the <strong>HAL Traits</strong> defined in <code>exo-core</code>. This allows the entire system to be retargeted (e.g., to WASM, to a microkernel) by simply swapping the HAL implementation.</li>
<li><strong>Scoped Execution</strong>: When a capsule runs, it is wrapped in a <code>ScopedHal</code> that provides a private, virtualized view of the system. This includes:
<ul>
<li><strong>Handle Registry</strong>: Maps virtual resource handles to real system handles, preventing resource harvesting.</li>
<li><strong>VFS Path Virtualization</strong>: Scopes all filesystem operations to a designated root directory (e.g., <code>~/.exo/vfs/&lt;capsule_name&gt;</code>).</li>
<li><strong>Environment Sandboxing</strong>: Provides isolated environment variables per capsule.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="capsule-isolation"><a class="header" href="#capsule-isolation">Capsule Isolation</a></h1>
<p>Crush implements strong isolation for capsules using a layered virtualization approach at the HAL (Hardware Abstraction Layer) level.</p>
<h2 id="mechanism"><a class="header" href="#mechanism">Mechanism</a></h2>
<p>When a VM is initialized with a <code>Manifest</code>, it wraps the base system HAL in a <code>ScopedHal</code>. This wrapper enforces two primary isolation boundaries:</p>
<h3 id="1-file-system-isolation-vfs"><a class="header" href="#1-file-system-isolation-vfs">1. File System Isolation (VFS)</a></h3>
<p>Each capsule is assigned a unique root directory on the host (typically <code>~/.exo/vfs/&lt;capsule_name&gt;</code>).</p>
<ul>
<li><strong>Path Resolution</strong>: The <code>Vfs</code> component translates virtual absolute paths (e.g., <code>/data/config.json</code>) into real host paths within the capsule's root.</li>
<li><strong>CWD Management</strong>: Each capsule maintains its own independent Current Working Directory within its virtual namespace.</li>
<li><strong>Escaping Prevention</strong>: The VFS prevents capsules from using <code>..</code> or leading <code>/</code> to access files outside their assigned root.</li>
</ul>
<h3 id="2-handle-virtualization-handleregistry"><a class="header" href="#2-handle-virtualization-handleregistry">2. Handle Virtualization (<code>HandleRegistry</code>)</a></h3>
<p>Raw system resource handles (memory allocations, file descriptors, network sockets) are never exposed directly to the capsule.</p>
<ul>
<li><strong>Virtual Handles</strong>: The <code>ScopedHal</code> generates virtual <code>Handle</code> IDs (starting at 100) and registers the mapping to real host handles in a <code>HandleRegistry</code>.</li>
<li><strong>Reference Guarding</strong>: Any HAL operation requested by the capsule uses these virtual handles. The <code>ScopedHal</code> resolves them to real handles before calling the underlying system HAL.</li>
<li><strong>Automatic Cleanup</strong>: When a capsule exits, its registry is destroyed, ensuring all virtual handles are invalidated.</li>
</ul>
<h3 id="3-environment-variable-isolation"><a class="header" href="#3-environment-variable-isolation">3. Environment Variable Isolation</a></h3>
<p>The <code>ScopedHal</code> maintains a per-capsule environment variable map. Capsules cannot see or modify the host environment or the environment of other capsules.</p>
<h2 id="security-properties"><a class="header" href="#security-properties">Security Properties</a></h2>
<ul>
<li><strong>Zero-Config Isolation</strong>: Simply running a capsule with a manifest automatically creates a sandboxed environment.</li>
<li><strong>Fine-Grained Permissions</strong>: The VM rejects any capability call that doesn't match the permissions declared in the capsule manifest, even before it reaches the HAL.</li>
<li><strong>Resource Limits</strong>: (Future) Metering is integrated into the <code>ScopedHal</code> to track and limit CPU, Memory, and I/O usage per capsule.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="capsule-design--package-management"><a class="header" href="#capsule-design--package-management">Capsule Design &amp; Package Management</a></h1>
<h2 id="1-the-capsule-format-cap"><a class="header" href="#1-the-capsule-format-cap">1. The Capsule Format (<code>.cap</code>)</a></h2>
<p>A <strong>Capsule</strong> is the fundamental unit of distribution in Crush. It is a compressed archive (ZIP) containing code, assets, and metadata.</p>
<h3 id="11-structure"><a class="header" href="#11-structure">1.1 Structure</a></h3>
<pre><code>my-package.cap (ZIP Archive)
â”œâ”€â”€ Crush.toml       # Manifest
â”œâ”€â”€ README.md        # Documentation
â”œâ”€â”€ signature.sig    # Cryptographic Signature (Ed25519)
â””â”€â”€ payload/         # Content
    â”œâ”€â”€ main.casm.json
    â”œâ”€â”€ lib.casm.json
    â””â”€â”€ assets/
        â””â”€â”€ data.csv
</code></pre>
<h3 id="12-manifest-crushtoml"><a class="header" href="#12-manifest-crushtoml">1.2 Manifest (<code>Crush.toml</code>)</a></h3>
<pre><code class="language-toml">[package]
name = "my-package"
version = "1.0.0"
authors = ["nixp"]
description = "A sample Crush capsule"
license = "MIT"

[capsule]
type = "binary" # binary, library, service, or generic
entry = "payload/main.casm.json" # Optional, for execution

[dependencies]
std = "0.1"
utils = { version = "1.2", source = "registry" }
</code></pre>
<h3 id="13-capsule-types"><a class="header" href="#13-capsule-types">1.3 Capsule Types</a></h3>
<ol>
<li><strong>Binary</strong>: Executable logic (CASM). Entry point required.</li>
<li><strong>Library</strong>: Reusable code. No entry point.</li>
<li><strong>Service</strong>: Long-running daemon config.</li>
<li><strong>Generic</strong>: Arbitrary data (models, datasets, UI assets). No strict structure required inside <code>payload/</code>.</li>
</ol>
<h2 id="2-package-management"><a class="header" href="#2-package-management">2. Package Management</a></h2>
<h3 id="21-the-repository"><a class="header" href="#21-the-repository">2.1 The Repository</a></h3>
<p>Capsules are stored in a Content-Addressable Store (CAS).</p>
<ul>
<li><strong>Local</strong>: <code>~/.crush/capsules/&lt;SHA256&gt;/</code></li>
<li><strong>Global</strong>: P2P Swarm.</li>
</ul>
<h3 id="22-identification"><a class="header" href="#22-identification">2.2 Identification</a></h3>
<p>Capsules are identified by:</p>
<ol>
<li><strong>Content Hash</strong>: Immutable reference (e.g., <code>sha256:abc123...</code>).</li>
<li><strong>Name/Version</strong>: Mutable reference resolved via Registry (e.g., <code>std@1.0.0</code>).</li>
</ol>
<h3 id="23-the-cpm-crush-package-manager"><a class="header" href="#23-the-cpm-crush-package-manager">2.3 The <code>cpm</code> (Crush Package Manager)</a></h3>
<p>Integrated into <code>crush</code> CLI.</p>
<pre><code class="language-bash"># Workflow
crush init            # Create Crush.toml
crush package         # Build .cap archive from current dir
crush publish         # Sign and announce to Federation
crush install &lt;name&gt;  # Resolve and download
crush run &lt;name&gt;      # Run installed capsule
</code></pre>
<h2 id="3-federation-strategy"><a class="header" href="#3-federation-strategy">3. Federation Strategy</a></h2>
<p>We leverage the <code>federation</code> crate for distribution.</p>
<ul>
<li><strong>Registry</strong>: A Kademlia DHT stores <code>package_name:version</code> -&gt; <code>content_hash</code>.</li>
<li><strong>Storage</strong>: Nodes serve the <code>.cap</code> files via Bitswap (or simple HTTP/RPC for v1).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crush-vm"><a class="header" href="#crush-vm">Crush VM</a></h1>
<p>The <strong>Crush VM</strong> (<code>crush-vm</code>) is a stack-based virtual machine designed to execute <strong>CASM</strong> (Crush Assembly).</p>
<h2 id="key-components"><a class="header" href="#key-components">Key Components</a></h2>
<h3 id="1-the-stack"><a class="header" href="#1-the-stack">1. The Stack</a></h3>
<p>Stores temporary values (<code>RuntimeValue</code>) during computation.</p>
<ul>
<li>Integers (<code>i64</code>)</li>
<li>Floats (<code>f64</code>)</li>
<li>Booleans (<code>bool</code>)</li>
<li>References (<code>Ref</code>) to heap objects</li>
</ul>
<h3 id="2-the-arena"><a class="header" href="#2-the-arena">2. The Arena</a></h3>
<p>A heap that stores complex objects like Strings, Arrays, and Maps. This avoids complex lifetime management in the VM implementation, using simple integer indices (<code>Ref</code>) instead.</p>
<h3 id="3-the-registry"><a class="header" href="#3-the-registry">3. The Registry</a></h3>
<p>Holds the set of available <strong>Capabilities</strong>. When the VM encounters a <code>cap_call</code> instruction, it looks up the implementation in the Registry.</p>
<h3 id="4-manifest-enforcement"><a class="header" href="#4-manifest-enforcement">4. Manifest Enforcement</a></h3>
<p>When initialized with a <code>Manifest</code>, the VM enforces that the code can only call capabilities explicitly listed in the manifest's <code>allowed_capabilities</code> section. It also wraps the system HAL in a <code>ScopedHal</code> for process-level isolation.</p>
<h3 id="5-local-scope-management"><a class="header" href="#5-local-scope-management">5. Local Scope Management</a></h3>
<p>The VM implements nested scope management for functions. Each function call creates a new local environment where parameters are bound to arguments, ensuring variables do not leak between function boundaries while allowing access to global and shared registries.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crush-lang--compilation"><a class="header" href="#crush-lang--compilation">Crush Lang &amp; Compilation</a></h1>
<p>Crush supports a custom scripting language (<code>.crush</code>) that compiles to <strong>CASM</strong>.</p>
<h2 id="compilation-pipeline-1"><a class="header" href="#compilation-pipeline-1">Compilation Pipeline</a></h2>
<ol>
<li><strong>Parsing</strong>: The source code is parsed into an Abstract Syntax Tree (AST).
<ul>
<li><code>crush-lang/src/ast.rs</code> defines the structure.</li>
</ul>
</li>
<li><strong>Compilation</strong>: The AST is traversed to generate linear CASM instructions.
<ul>
<li><code>crush-lang/src/compiler.rs</code> handles the translation.</li>
<li>Example: <code>1 + 2</code> becomes <code>push_int 1</code>, <code>push_int 2</code>, <code>add</code>.</li>
</ul>
</li>
<li><strong>Execution</strong>: The resulting <code>Program</code> struct (containing functions and instructions) is loaded into the VM.</li>
</ol>
<h2 id="polyglot-support"><a class="header" href="#polyglot-support">Polyglot Support</a></h2>
<p>Because the VM executes CASM, any language that can compile to CASM can run on Crush.</p>
<ul>
<li><strong>Python</strong>: A python walker can traverse Python AST and emit CASM.</li>
<li><strong>Rust</strong>: A Rust compiler plugin or walker can emit CASM.</li>
<li><strong>Bash</strong>: A shell script parser can emit CASM.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="standard-library-reference"><a class="header" href="#standard-library-reference">Standard Library Reference</a></h1>
<p>The Crush Standard Library (<code>crush-stdlib</code>) provides essential capabilities for interacting with the system.</p>
<ul>
<li><a href="./stdlib_io.html">I/O Module</a>: Input/Output operations.</li>
<li><a href="./stdlib_fs.html">Filesystem Module</a>: File and directory management.</li>
<li><a href="./stdlib_system.html">System Module</a>: System information and environment.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="io-module-io"><a class="header" href="#io-module-io">I/O Module (<code>io</code>)</a></h1>
<p>Provides input and output capabilities.</p>
<h2 id="capabilities-1"><a class="header" href="#capabilities-1">Capabilities</a></h2>
<h3 id="ioprint"><a class="header" href="#ioprint"><code>io.print</code></a></h3>
<p>Prints arguments to standard output, followed by a newline.</p>
<ul>
<li><strong>Args</strong>: <code>vl: Any...</code></li>
<li><strong>Example</strong>: <code>io.print("Hello", 123)</code></li>
</ul>
<h3 id="ioecho"><a class="header" href="#ioecho"><code>io.echo</code></a></h3>
<p>Prints arguments to standard output, separated by spaces, followed by a newline.</p>
<ul>
<li><strong>Args</strong>: <code>vl: Any...</code></li>
<li><strong>Example</strong>: <code>io.echo("Hello", "World")</code></li>
</ul>
<h3 id="ioinput"><a class="header" href="#ioinput"><code>io.input</code></a></h3>
<p>Reads a line from standard input.</p>
<ul>
<li><strong>Args</strong>: None</li>
<li><strong>Returns</strong>: <code>String</code></li>
<li><strong>Example</strong>: <code>var name = io.input()</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="filesystem-module-fs"><a class="header" href="#filesystem-module-fs">Filesystem Module (<code>fs</code>)</a></h1>
<p>Provides capabilities for file and directory manipulation.</p>
<h2 id="capabilities-2"><a class="header" href="#capabilities-2">Capabilities</a></h2>
<h3 id="fsread"><a class="header" href="#fsread"><code>fs.read</code></a></h3>
<p>Reads the entire content of a file as a string.</p>
<ul>
<li><strong>Args</strong>: <code>path: String</code></li>
<li><strong>Returns</strong>: <code>String</code></li>
<li><strong>Example</strong>: <code>var content = fs.read("data.txt")</code></li>
</ul>
<h3 id="fswrite"><a class="header" href="#fswrite"><code>fs.write</code></a></h3>
<p>Writes a string to a file, overwriting it or creating it if it doesn't exist.</p>
<ul>
<li><strong>Args</strong>: <code>path: String</code>, <code>content: String</code></li>
<li><strong>Returns</strong>: <code>Null</code></li>
<li><strong>Example</strong>: <code>fs.write("log.txt", "Log entry")</code></li>
</ul>
<h3 id="fsls"><a class="header" href="#fsls"><code>fs.ls</code></a></h3>
<p>Lists the contents of a directory.</p>
<ul>
<li><strong>Args</strong>: <code>path: String</code> (optional, defaults to current dir)</li>
<li><strong>Returns</strong>: <code>Array&lt;String&gt;</code></li>
<li><strong>Example</strong>: <code>var files = fs.ls(".")</code></li>
</ul>
<h3 id="fscd"><a class="header" href="#fscd"><code>fs.cd</code></a></h3>
<p>Changes the current working directory.</p>
<ul>
<li><strong>Args</strong>: <code>path: String</code></li>
<li><strong>Returns</strong>: <code>Null</code></li>
<li><strong>Example</strong>: <code>fs.cd("/tmp")</code></li>
</ul>
<h3 id="fspwd"><a class="header" href="#fspwd"><code>fs.pwd</code></a></h3>
<p>Returns the current working directory.</p>
<ul>
<li><strong>Args</strong>: None</li>
<li><strong>Returns</strong>: <code>String</code></li>
<li><strong>Example</strong>: <code>var cwd = fs.pwd()</code></li>
</ul>
<h3 id="fsmv"><a class="header" href="#fsmv"><code>fs.mv</code></a></h3>
<p>Moves or renames a file or directory.</p>
<ul>
<li><strong>Args</strong>: <code>from: String</code>, <code>to: String</code></li>
<li><strong>Returns</strong>: <code>Null</code></li>
<li><strong>Example</strong>: <code>fs.mv("old.txt", "new.txt")</code></li>
</ul>
<h3 id="fsrm"><a class="header" href="#fsrm"><code>fs.rm</code></a></h3>
<p>Removes a file or directory.</p>
<ul>
<li><strong>Args</strong>: <code>path: String</code></li>
<li><strong>Returns</strong>: <code>Null</code></li>
<li><strong>Example</strong>: <code>fs.rm("temp.txt")</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-module-system"><a class="header" href="#system-module-system">System Module (<code>system</code>)</a></h1>
<p>Provides access to system information and environment.</p>
<h2 id="capabilities-3"><a class="header" href="#capabilities-3">Capabilities</a></h2>
<h3 id="systemenv"><a class="header" href="#systemenv"><code>system.env</code></a></h3>
<p>Returns a Map of all environment variables.</p>
<ul>
<li><strong>Args</strong>: None</li>
<li><strong>Returns</strong>: <code>Map&lt;String, String&gt;</code></li>
<li><strong>Example</strong>: <code>var env = system.env(); io.print(env.PATH)</code></li>
</ul>
<h3 id="systemos"><a class="header" href="#systemos"><code>system.os</code></a></h3>
<p>Returns information about the operating system.</p>
<ul>
<li><strong>Args</strong>: None</li>
<li><strong>Returns</strong>: <code>Map&lt;String, String&gt;</code> containing <code>os</code>, <code>arch</code>, <code>family</code>.</li>
<li><strong>Example</strong>: <code>var info = system.os(); io.print(info.os)</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tools-reference"><a class="header" href="#tools-reference">Tools Reference</a></h1>
<p>Reference documentation for the Crush command-line tools.</p>
<ul>
<li><a href="./cli_usage.html">CLI Usage</a>: The <code>crush</code> binary options and subcommands.</li>
<li><a href="./pacman.html">Pacman</a>: The built-in package manager.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-usage"><a class="header" href="#cli-usage">CLI Usage</a></h1>
<p>The <code>crush</code> binary is the primary entry point for all Crush operations.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<pre><code class="language-bash">crush [OPTIONS] &lt;COMMAND&gt;
</code></pre>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<h3 id="run"><a class="header" href="#run"><code>run</code></a></h3>
<p>Executes a script.</p>
<pre><code class="language-bash">crush run &lt;FILE&gt;
</code></pre>
<h3 id="repl"><a class="header" href="#repl"><code>repl</code></a></h3>
<p>Starts the interactive Read-Eval-Print Loop.</p>
<pre><code class="language-bash">crush repl
</code></pre>
<h3 id="pacman"><a class="header" href="#pacman"><code>pacman</code></a></h3>
<p>Access package management commands.</p>
<pre><code class="language-bash">crush pacman [SUBCOMMAND]
</code></pre>
<h3 id="compile"><a class="header" href="#compile"><code>compile</code></a></h3>
<p>Compiles a script to CASM (for debugging).</p>
<pre><code class="language-bash">crush compile &lt;FILE&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pacman-1"><a class="header" href="#pacman-1">Pacman</a></h1>
<p><strong>Pacman</strong> is the Package Manager for Crush. It manages <strong>Capsules</strong>, which are isolated units of software.</p>
<h2 id="philosophy"><a class="header" href="#philosophy">Philosophy</a></h2>
<p>Pacman manages capsules in a local registry (<code>~/.crush/capsules</code>). It ensures that executed software is tracked, versioned, and verified.</p>
<h2 id="commands-1"><a class="header" href="#commands-1">Commands</a></h2>
<h3 id="install"><a class="header" href="#install"><code>install</code></a></h3>
<p>Installs a capsule from a local directory or archive.</p>
<pre><code class="language-bash">crush pacman install ./my_capsule
</code></pre>
<h3 id="remove"><a class="header" href="#remove"><code>remove</code></a></h3>
<p>Removes an installed capsule.</p>
<pre><code class="language-bash">crush pacman remove my_capsule
</code></pre>
<h3 id="list"><a class="header" href="#list"><code>list</code></a></h3>
<p>Lists all installed capsules.</p>
<pre><code class="language-bash">crush pacman list
</code></pre>
<h3 id="run-1"><a class="header" href="#run-1"><code>run</code></a></h3>
<p>Runs an installed capsule.</p>
<pre><code class="language-bash">crush pacman run my_capsule
</code></pre>
<h3 id="info"><a class="header" href="#info"><code>info</code></a></h3>
<p>Displays detailed information about a capsule.</p>
<pre><code class="language-bash">crush pacman info my_capsule
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
